---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# Addresses maintenance plan 23465 (openssl vulnerabilities)
# https://access.redhat.com/insights/planner/23465
# Generated by Red Hat Insights on Mon, 26 Jun 2017 19:14:24 GMT

# OpenSSL vulnerable to session decryption (CVE-2016-0800/DROWN)
# Identifier: (CVE_2016_0800_openssl_drown|OPENSSL_CVE_2016_0800_DROWN,105,openssl_update)
# Version: dcb7b3a563a199c3b2d5b538555b4fbddeffa115
- name: update openssl package and reboot host
  hosts: "rhel7vm1.chen.com,rhel7vm2.chen.com"
  become: true
  vars:
    package: "{{'openssl-libs' if ansible_distribution_major_version == '7' else 'openssl'}}"

  tasks:
    - name: Update openssl
      yum:
        name: "{{package}}"
        state: latest
      register: openssl_updated

    - when: openssl_updated|changed
      block:
      - name: Reboot machine
        shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
        async: 1
        poll: 0

      - name: Wait for machine to finish rebooting
        local_action: wait_for host={{ inventory_hostname }} port=22 state=started delay=10 timeout=300
        become: false


- name: run insights
  hosts: rhel7vm1.chen.com,rhel7vm2.chen.com
  become: True
  tasks:
    - name: run insights
      command: redhat-access-insights
      changed_when: false